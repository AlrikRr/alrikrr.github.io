<!DOCTYPE html><html lang="en-ca"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Malware Analysis - Kardon Loader - AlrikRr&#x27;s Blog</title><meta name="description" content="Hi ! Here is my Malware Analysis of Kardon Loader (Static and Dynamic) Enjoy ! There are 4 sections :&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><script type="gdpr-blocker/Google Analytics">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
						new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
						j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
						'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','G-22SHFE01F3');</script><link rel="stylesheet" href="https://alrikrr.github.io/media/plugins/syntaxHighlighter/prism-black.css"><link rel="canonical" href="https://alrikrr.github.io/malware-analysis-kardon-loader/"><link rel="alternate" type="application/atom+xml" href="https://alrikrr.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://alrikrr.github.io/feed.json"><meta property="og:title" content="Malware Analysis - Kardon Loader"><meta property="og:image" content="https://alrikrr.github.io/media/posts/17/pa.jpg"><meta property="og:image:width" content="1920"><meta property="og:image:height" content="1095"><meta property="og:site_name" content="AlrikRr's Blog"><meta property="og:description" content="Hi ! Here is my Malware Analysis of Kardon Loader (Static and Dynamic) Enjoy ! There are 4 sections :&hellip;"><meta property="og:url" content="https://alrikrr.github.io/malware-analysis-kardon-loader/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@alrikrr"><meta name="twitter:title" content="Malware Analysis - Kardon Loader"><meta name="twitter:description" content="Hi ! Here is my Malware Analysis of Kardon Loader (Static and Dynamic) Enjoy ! There are 4 sections :&hellip;"><meta name="twitter:image" content="https://alrikrr.github.io/media/posts/17/pa.jpg"><link rel="shortcut icon" href="https://alrikrr.github.io/media/website/android-chrome-192x192.png" type="image/x-icon"><link rel="stylesheet" href="https://alrikrr.github.io/assets/css/fontawesome-all.min.css?v=bbcde81f26378440dac4c3d195714389"><link rel="stylesheet" href="https://alrikrr.github.io/assets/css/style.css?v=9b43267d2b7457feeb36a64550d71700"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://alrikrr.github.io/malware-analysis-kardon-loader/"},"headline":"Malware Analysis - Kardon Loader","datePublished":"2022-01-28T21:17","dateModified":"2023-08-22T14:08","image":{"@type":"ImageObject","url":"https://alrikrr.github.io/media/posts/17/pa.jpg","height":1095,"width":1920},"description":"Hi ! Here is my Malware Analysis of Kardon Loader (Static and Dynamic) Enjoy ! There are 4 sections :&hellip;","author":{"@type":"Person","name":"AlrikRr","url":"https://alrikrr.github.io/authors/alrikrr/"},"publisher":{"@type":"Organization","name":"AlrikRr"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="is-preload"><div id="wrapper"><div id="main"><div class="inner"><header id="header"><a class="logo" href="https://alrikrr.github.io/"><strong>AlrikRr&#x27;s Blog</strong></a><ul class="icons"><li><a href="https://twitter.com/AlrikRr" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li><li><a href="https://www.linkedin.com/in/adrien-lasalle/" class="icon brands fa-linkedin"><span class="label">LinkedIn</span></a></li><li><a href="https://www.youtube.com/channel/UCHUrf2NqybwOFQ6tfYt3zNA" class="icon brands fa-youtube"><span class="label">YouTube</span></a></li></ul></header><article class="post"><header class="main post__header"><time datetime="2022-01-28T21:17" class="post__date">28 January 2022</time><h1>Malware Analysis - Kardon Loader</h1></header><figure class="image main"><img src="https://alrikrr.github.io/media/posts/17/pa.jpg" srcset="https://alrikrr.github.io/media/posts/17/responsive/pa-xs.jpg 300w, https://alrikrr.github.io/media/posts/17/responsive/pa-sm.jpg 480w, https://alrikrr.github.io/media/posts/17/responsive/pa-md.jpg 768w, https://alrikrr.github.io/media/posts/17/responsive/pa-lg.jpg 1024w, https://alrikrr.github.io/media/posts/17/responsive/pa-xl.jpg 1360w, https://alrikrr.github.io/media/posts/17/responsive/pa-xxl.jpg 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="lazy" height="1095" width="1920" alt=""></figure><div class="post__inner post__entry"><p>Hi ! Here is my Malware Analysis of Kardon Loader (Static and Dynamic)</p><p>Enjoy !</p><hr><h1 id="identification">Identification</h1><table><thead><tr><th>Name</th><th>kardon.exe</th></tr></thead><tbody><tr><td>Hash (256)</td><td>555675C526F80B9C89E02CA9D2C27F0EA61AD400</td></tr><tr><td>FileType</td><td>PE 32 bit</td></tr><tr><td>TimeStamp</td><td>5AFD5BE1 —&gt;  GMT: Thursday 17 May 2018 10:39:29</td></tr><tr><td>FileSize</td><td>10KB</td></tr><tr><td>ImageBase</td><td>000011AD</td></tr><tr><td>EntryPoint(RVA)</td><td>00400000</td></tr><tr><td>VA(IB+RVA)</td><td>004011AD</td></tr></tbody></table><h1 id="sections">Sections</h1><p>There are 4 sections :</p><ul><li>.text</li><li>.rdata</li><li>.data</li><li>.reloc</li></ul><h2 id="imports">Imports</h2><p>Interesting DLLs :</p><ul><li>urlmon.dll: <em><strong>URLDownloadToFileA()</strong></em></li><li>SHELL32.dll: <em><strong>SHGetFolderPathA()</strong></em></li><li>KERNEL32.dll: <em><strong>GetCommandLineA(), MoveFileExA(), WinExec(), GetCurrentProcess(), etc.</strong></em></li><li>ADVAPI32.dll: <em><strong>RegCreateKeyA(), RegSetValueExA(), etc.</strong></em></li></ul><blockquote><p>💡 The identification of the malware is done, we have a better understanding of the malware at the moment. We can see that it uses some functions, <strong>especially the manipulation of registers and documents</strong>. We can think about a <strong>persistence on our system</strong>. A possibility to <strong>download files from the Internet</strong> with urlmon.dll. Then we can see that there is an <strong>anti-debug system on a virtual machine</strong>. This suggests that the hacker behind this malware doesn’t want us to look further into his malware. Now let’s move on to the static analysis.</p></blockquote><h1 id="static-analysis">Static Analysis</h1><p>We start our static analysis with the <strong>Hacker Resources</strong> tool. Unfortunately, this did not give us any data. No resources are present in our malware.</p><p>We will continue using IDA Pro.</p><h2 id="ida-pro---main-address">IDA Pro - Main Address</h2><p>First of all, we need to <strong>jump to the main address</strong>. Sometimes you don’t need to jump, you just spawn on the main function but to do so, just press “g” and enter <strong>the VA that we find earlier</strong>.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/kardon/Untitled.png" alt="Untitled" width="511" height="303" data-is-external-image="true"></p><h2 id="ida-pro---anti-vm--bypass">IDA Pro - Anti-VM &amp; Bypass</h2><p>As we saw during the identification of our malware, virtual machine anti-debug functions were present.</p><p>These functions, or checks, are there to verify if the malware is running in a virtualization environment or not. In most cases, and [Spoilers] in this one as well, if the malware is running on a virtual machine, it automatically shuts down, in order to avoid it being analyzed.</p><p>Fortunately, this kind of protection is easy to bypass.</p><p>In the screenshot below you can see at address <strong><code>0x0040148B</code></strong> a function that checks the presence of virtual environments dlls like VMWare, VirtualBox, KVM, etc.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/kardon/Untitled1.png" alt="Anti-VM check used by Kardon" width="744" height="469" data-is-external-image="true"></p><p>Anti-VM check used by Kardon</p><p>At the address <strong><code>0x00401521</code></strong>, right after the CheckVM function(<strong><code>0x0040148B</code></strong>).</p><p>This variable, to make it simple, is by default at <code>1</code> when passing in this instruction. So, if the malware is in a virtual machine, the variable will be set to <code>1</code>.</p><p>The final condition would be, if variable is equal to <code>1</code>, it is a virtual machine, so shutdown. If the variable is equal to <code>0</code>, it’s ok, continue.</p><p>If you want to see all the function CheckVM, just press “space” when you’re on it and you’ll see all the function + instructions.</p><p>In our case, it will never be set to 1 because <strong>we will replace the 1 by a 0</strong>.</p><p>To do so, just click on the 1 from <strong>“<code>mov al, 1</code>”</strong> then in the hexadecimal editor integrated into IDA (Hex View-1), press F2 and change <code>01</code> by <code>00</code>. Like in the example below.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/kardon/Untitled2.png" alt="Replace 01 by 00 in hexa to by-pass the Anti-VM protection." width="745" height="454" data-is-external-image="true"></p><p>Replace 01 by 00 in hexa to by-pass the Anti-VM protection.</p><p><strong>This bypass will allow us to execute the malware during the dynamic analysis.</strong></p><h2 id="ida-pro---anti-virus-check">IDA-Pro - Anti-Virus check</h2><p>At the address <strong><code>0x00401BDC</code></strong> there is a function that we are going to call <strong><code>CheckAV()</code>.</strong> This function will simply check if there are dlls related to AntiVirus protection. Like the <strong><code>CheckVM()</code></strong> function, if these dlls are in the machine, the malware will stop.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/kardon/Untitled3.png" alt="Anti-Virus dll check used by Kardon" width="819" height="380" data-is-external-image="true"></p><p>Anti-Virus dll check used by Kardon</p><p>Like the <code>CheckVM()</code> function, this one can be bypass too, using the same method. The instruction is located at the address <strong><code>0x00401C43</code>.</strong></p><h2 id="ida-pro---kardon-checking-so-far">IDA-Pro - Kardon Checking so far</h2><p>Here is a little recap from the checking in place in this malware ( CheckVM is not here). As we can see, these checks are coded the same way and can be bypass easily. The last one is a function that check if the malware is running inside a Wine emulator from Linux.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/kardon/Untitled4.png" alt="Untitled" width="577" height="402" data-is-external-image="true"></p><h2 id="ida-pro---cc">IDA-Pro - C&amp;C</h2><p>At the address <strong><code>0x00401AB0</code></strong>, just before the <strong><code>CheckWineLinux()</code></strong> function we can see the C&amp;C used by the malware.</p><p>We can also see the name of the page that is trigger, here <strong><code>gate.php</code></strong> into the Kardon folder.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/kardon/Untitled5.png" alt="Untitled" data-is-external-image="true"></p><p>This IOC is a very important information, using this we can for example block any communication to the destination of <strong><code>kardon.ddns.net</code></strong>.</p><h2 id="ida-pro---registry-key">IDA-Pro - Registry Key</h2><p>Last part of this static analysis, at the address <strong><code>0x00401B0B</code></strong> we can see a Registry Key and some system function used for registry key creation and manipulation.</p><p>When we start talking about manipulation of the Windows registry, the first thing that comes to our mind is the persistence of malware on the system.</p><p>Here we can see a <strong>SubKey</strong> : <strong><code>“SOFTWARE\Microsoft\Windows\CurrentVersion\Run”</code></strong></p><p><strong>The Holy Microsoft documentation says:</strong></p><blockquote><p>“Run and RunOnce registry keys cause programs to run each time a user logs on. The data value for a key is a command line no longer than 260 characters.”</p></blockquote><p>There is also two <strong>hKey</strong>: <strong><code>“80000002h”</code></strong> &amp; <strong><code>“80000002h”</code></strong></p><p>The value is a const value, here It is easy to find the exact value of the hKey.</p><pre tabindex="0"><code class="hljs php"><span class="hljs-keyword">Const</span> HKEY_CLASSES_ROOT     = &amp;H80000000
<span class="hljs-keyword">Const</span> HKEY_CURRENT_USER     = &amp;H80000001
<span class="hljs-keyword">Const</span> HKEY_LOCAL_MACHINE    = &amp;H80000002
<span class="hljs-keyword">Const</span> HKEY_USERS        = &amp;H80000003
<span class="hljs-keyword">Const</span> HKEY_CURRENT_CONFIG   = &amp;H80000005
</code></pre><p>And we can see a lot of system function such as:</p><ul><li><strong>RegCreateKeyA</strong> : “Creates the specified registry key. If the key already exists in the registry, the function opens it.” <strong>Here this function is called 2 times so there is a creation and an edit.</strong></li><li><strong>GetSystemDirectoryA</strong> : Retrieves the path of the system directory. The system directory contains system files such as dynamic-link libraries and drivers.</li><li><strong>SHGetFolderPathA</strong> : “ Gets the path of a folder identified by a <a href="https://docs.microsoft.com/en-us/windows/desktop/shell/csidl">CSIDL</a> value.”</li></ul><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/kardon/Untitled6.png" alt="Capture of the HKEY used by Kardon" width="730" height="365" data-is-external-image="true"></p><p>Capture of the HKEY used by Kardon</p><p>In conclusion, there is the creation of a registry key that allows the malware to execute at each login of the victim. Moreover, we can see a creation and a modification of the key.</p><p>We will see in more detail what happens in the dynamic analysis.</p><h1 id="dynamic-analysis">Dynamic Analysis</h1><blockquote><p>⚠️ <strong>Before executing this part, make sure you protect your system properly so as not to damage your computer. Also remember to make a snapshot of your system before each execution.</strong></p></blockquote><h2 id="procmon">Procmon</h2><p>As our malware is patched (Bypass CheckVM, CheckAV, etc.) it runs correctly on the analysis system. The first thing to do is to run Procmon with the correct filters and then run the malware. This will give us a better understanding of how it works on the system.</p><p>As suspected, <strong>we see the creation of a registry key but we also see its modification</strong>. This function takes on its full meaning when you look at what happens next. Indeed, we can see our malware being copied into <code>%APPDATA%</code> under a random name and <strong>then adding its new path+name into the registry key</strong>. Which is why we use the <strong><code>GetSystemDirectoryA</code></strong> function seen earlier.</p><p>This makes sense because, once executed, the <strong>Kardon.exe malware deletes itself</strong> to leave only <strong>its copy in <code>%APPDATA%</code></strong>. It gets the full path of the copy into the registry Key created before. Every execution, this malware changes it name and the registry key. By the way the name of the autorun key is <strong>“Microsoft Update”.</strong></p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/kardon/Untitled7.png" alt="Untitled" width="846" height="511" data-is-external-image="true"></p><h2 id="procmon---conclusion">Procmon - Conclusion</h2><p>To conclude, it is possible to push this analysis even further. Indeed, since we have at our disposal the C&amp;C and a better understanding of its behavior, it is possible to create a C&amp;C of the same name so that Kardon communicates with it.</p><p>This will allow us to see in more detail the communications and data exchanges between the two.</p></div><footer class="post__inner post__footer"><p class="post__last-updated">This article was updated on 22 August 2023</p><div class="post__share"><h3>Share post:</h3><a href="https://twitter.com/share?url=https%3A%2F%2Falrikrr.github.io%2Fmalware-analysis-kardon-loader%2F&amp;via=%40AlrikRr&amp;text=Malware%20Analysis%20-%20Kardon%20Loader" class="js-share icon brands fa-twitter" rel="nofollow noopener noreferrer"><span class="label">Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Falrikrr.github.io%2Fmalware-analysis-kardon-loader%2F" class="js-share icon brands fa-linkedin" rel="nofollow noopener noreferrer"><span class="label">LinkedIn</span> </a><a href="https://api.whatsapp.com/send?text=Malware%20Analysis%20-%20Kardon%20Loader https%3A%2F%2Falrikrr.github.io%2Fmalware-analysis-kardon-loader%2F" class="js-share icon brands fa-whatsapp" rel="nofollow noopener noreferrer"><span class="label">WhatsApp</span></a></div><div class="post__tag"><ul><li><strong>Tagged in:</strong></li><li><a href="https://alrikrr.github.io/tags/malware/">Malware</a></li><li><a href="https://alrikrr.github.io/tags/malware-analysis/">Malware Analysis</a></li></ul></div><div class="post__bio"><img src="https://alrikrr.github.io/media/website/1675479739617.jpeg" loading="lazy" height="697" width="697" alt="AlrikRr"><div><h3><a href="https://alrikrr.github.io/authors/alrikrr/" class="invert" rel="author">AlrikRr</a></h3><p>Former Firefighter 🚒, I decided to follow my passion in computer security and pursue my studies in this domain. After a few moves all over France 🇫🇷 and 4 months of study in Warsaw, Poland, I was able to join Canada 🇨🇦 and start a new life!<br>📨 Feel free to contact me to talk cyber over coffee ☕️ !</p><ul><li class="align-left">My Github Account: <a href="https://github.com/AlrikRr" title="My Github" target="_blank" rel="noopener">AlrikRr</a></li><li class="align-left">My Twitter Account: <a href="https://twitter.com/AlrikRr" title="My Twitter" target="_blank" rel="noopener">AlrikRr</a></li><li class="align-left">Infosec.Exchange: <a href="https://infosec.exchange/@AlrikRr" title="My Mastodon Account" target="_blank" rel="noopener">@AlrikRr</a></li></ul></div></div></footer></article></div></div><div id="sidebar"><div class="inner"><nav id="menu"><header class="major"><h2>Menu</h2></header><ul><li><a href="https://alrikrr.github.io/" target="_self">Home 🏠</a></li><li><a href="https://alrikrr.github.io/authors/alrikrr/" target="_self">About me 👺</a></li><li class="has-submenu"><a href="https://alrikrr.github.io/tags/" target="_self" aria-haspopup="true" class="opener">Categories 🗂️</a><ul class="submenu level-2" aria-hidden="true"><li><a href="https://alrikrr.github.io/tags/" target="_self">All</a></li><li><a href="https://alrikrr.github.io/tags/updates/" target="_self">Personal Updates</a></li><li><a href="https://alrikrr.github.io/tags/flipperzero/" target="_self">FlipperZero</a></li><li><a href="https://alrikrr.github.io/tags/8-bits-computer/" target="_self">8 Bits Computer</a></li><li><a href="https://alrikrr.github.io/tags/iot-hacking/" target="_self">IoT Hacking</a></li><li><a href="https://alrikrr.github.io/tags/reverse-engineering/" target="_self">Reverse Engineering</a></li><li><a href="https://alrikrr.github.io/tags/malware/" target="_self">Malware</a></li><li><a href="https://alrikrr.github.io/tags/raspberrypi/" target="_self">RaspberryPi</a></li><li><a href="https://alrikrr.github.io/tags/pentesting/" target="_self">Pentesting</a></li><li><a href="https://alrikrr.github.io/tags/write-up/" target="_self">Write Up</a></li></ul></li><li class="has-submenu"><span aria-haspopup="true" class="opener">Projects 🚧</span><ul class="submenu level-2" aria-hidden="true"><li><a href="https://github.com/AlrikRr/Cisco-Smart-Exploit" target="_blank">Cisco-Smart-Exploit</a></li><li><a href="https://github.com/AlrikRr/Forensic-Extract" target="_blank">Forensic-Extract</a></li><li><a href="https://github.com/AlrikRr/USBGuardian" target="_self">USBGuardian (fork)</a></li><li><a href="https://github.com/AlrikRr/DFIR-ExtracTux" target="_blank">DFIR-Extractux</a></li></ul></li><li><a href="https://www.buymeacoffee.com/AlrikRr" target="_blank">Buy me a beer 🍺</a></li></ul></nav><section><header class="major"><h2>Get in touch</h2></header><p>📨 Feel free to contact me to talk cyber over coffee ☕️ !<br><br>=== Area of expertise ===<br>📍 Web Application Pentest (OWASP)<br>📍 Internal Active Directory &amp; SCADA Pentest<br>📍 Pentest Cloud Azure<br>📍 Python &amp; PowerShell development<br>📍 Malware Analysis</p><ul class="contact"><li class="icon solid fa-envelope">adrienlasalle[dot]pro[at]gmail[dot]com</li><li class="icon solid fa-home">Montréal, Qc 🇨🇦</li></ul></section><footer id="footer"><p class="copyright">© AlrikRr 2023 - All rights reserved</p></footer></div></div></div><script src="https://alrikrr.github.io/assets/js/jquery.min.js?v=7c14a783dfeb3d238ccd3edd840d82ee"></script><script src="https://alrikrr.github.io/assets/js/browser.min.js?v=c07298dd19048a8a69ad97e754dfe8d0"></script><script src="https://alrikrr.github.io/assets/js/breakpoints.min.js?v=81a479eb099e3b187613943b085923b8"></script><script src="https://alrikrr.github.io/assets/js/util.min.js?v=cbdaf7c20ac2883c77ae23acfbabd47e"></script><script src="https://alrikrr.github.io/assets/js/main.min.js?v=08add7f6d435054ad38ec38d7cf8be40"></script><script>var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};</script><script defer="defer" src="https://alrikrr.github.io/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://alrikrr.github.io/media/plugins/syntaxHighlighter/prism-line-numbers.min.js"></script><script defer="defer" src="https://alrikrr.github.io/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://alrikrr.github.io/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site for statistic purpose.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>